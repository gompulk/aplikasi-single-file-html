<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KopiKu - Coffee Shop Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        /* Variabel Warna Global untuk Tema */
        :root {
            --theme-primary: #8B5CF6; /* ungu */
            --theme-primary-hover: #7C3AED;
            --theme-text: #8B5CF6;
            --theme-gradient-from: #8B5CF6;
            --theme-gradient-to: #2563EB;
        }

        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Kelas utilitas baru untuk menggunakan variabel tema */
        .bg-theme-primary { background-color: var(--theme-primary); }
        .hover\:bg-theme-primary-hover:hover { background-color: var(--theme-primary-hover); }
        .text-theme-primary { color: var(--theme-text); }
        .border-theme-primary { border-color: var(--theme-primary); }
        .gradient-theme { background-image: linear-gradient(to right, var(--theme-gradient-from), var(--theme-gradient-to)); }


        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--theme-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .print-only { display: none; }
        @media print { .print-only { display: block; } .no-print { display: none; } }

        /* Styling tambahan untuk dropdown pratinjau */
        .icon-select-wrapper {
            position: relative;
        }
        .icon-select-wrapper select {
            padding-left: 3rem; /* Memberi ruang untuk ikon pratinjau */
        }
        .icon-preview-box {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--theme-primary);
            font-size: 1.25rem;
            pointer-events: none; /* agar bisa klik selectnya */
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen">
        <header class="bg-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <span data-icon="coffee-cup" class="text-theme-primary text-2xl"></span>
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800" id="merchantName">KopiKu Coffee Shop</h1>
                    </div>
                    <nav class="hidden md:flex items-center space-x-4">
                        <button onclick="showPage('home')" class="nav-btn text-gray-600 hover:text-theme-primary transition">
                            <span data-icon="home" class="mr-2"></span>Beranda
                        </button>
                        <button onclick="showPage('menu')" class="nav-btn text-gray-600 hover:text-theme-primary transition">
                            <span data-icon="menu" class="mr-2"></span>Menu
                        </button>
                        <button onclick="showPage('queue')" class="nav-btn text-gray-600 hover:text-theme-primary transition">
                            <span data-icon="queue" class="mr-2"></span>Antrian
                        </button>
                        <button onclick="showPage('contact')" class="nav-btn text-gray-600 hover:text-theme-primary transition">
                            <span data-icon="contact" class="mr-2"></span>Kontak
                        </button>
                        <button onclick="showLoginModal()" class="bg-theme-primary text-white px-4 py-2 rounded-lg hover:bg-theme-primary-hover transition">
                            <span data-icon="admin" class="mr-2"></span>Admin
                        </button>
                    </nav>
                    <div class="md:hidden">
                         <button onclick="showLoginModal()" class="bg-theme-primary text-white px-3 py-2 rounded-lg hover:bg-theme-primary-hover transition">
                            <i class="fas fa-user-shield"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <section id="jumbotron" class="relative gradient-theme text-white py-20">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-4xl md:text-5xl font-bold mb-4" id="jumbotronTitle">Selamat Datang di KopiKu</h2>
                <p class="text-lg md:text-xl mb-8" id="jumbotronSubtitle">Nikmati kopi terbaik dengan suasana yang nyaman</p>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="showPage('menu')" class="bg-white text-theme-primary px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition hover-scale">
                        <span data-icon="cart" class="mr-2"></span>Pesan Sekarang
                    </button>
                    <button onclick="showPage('queue')" class="border-2 border-white text-white px-8 py-3 rounded-full font-semibold hover:bg-white hover:text-theme-primary transition hover-scale">
                        <span data-icon="queue" class="mr-2"></span>Lihat Antrian
                    </button>
                </div>
            </div>
        </section>

        <main class="container mx-auto px-4 py-8">
            <div id="homePage" class="page-content">
                <div class="grid md:grid-cols-3 gap-8 mb-12">
                    <div class="bg-white p-6 rounded-xl shadow-lg hover-scale">
                        <div class="text-theme-primary text-4xl mb-4">
                            <span data-icon="coffee-cup"></span>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">Kopi Premium</h3>
                        <p class="text-gray-600">100% kopi pilihan dengan kualitas terbaik</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg hover-scale">
                        <div class="text-theme-primary text-4xl mb-4">
                           <span data-icon="wifi"></span>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">WiFi Gratis</h3>
                        <p class="text-gray-600">Nikmati koneksi internet cepat dan gratis</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg hover-scale">
                        <div class="text-theme-primary text-4xl mb-4">
                            <span data-icon="couch"></span>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">Ruangan Nyaman</h3>
                        <p class="text-gray-600">Suasana cozy yang bikin betah berlama-lama</p>
                    </div>
                </div>

                <div class="mb-12">
                    <h2 class="text-3xl font-bold text-center mb-8">Produk Unggulan</h2>
                    <div id="featuredProducts" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                        </div>
                </div>
            </div>

            <div id="menuPage" class="page-content hidden">
                <h2 class="text-3xl font-bold mb-8 text-center">Menu Kami</h2>
                
                <div class="flex justify-center mb-8">
                    <div class="bg-white rounded-lg shadow-md p-1 inline-flex flex-wrap">
                        <button onclick="filterProducts('all')" class="category-btn px-4 py-2 sm:px-6 rounded-md transition" data-category="all">Semua</button>
                        <button onclick="filterProducts('coffee')" class="category-btn px-4 py-2 sm:px-6 rounded-md transition" data-category="coffee">Kopi</button>
                        <button onclick="filterProducts('food')" class="category-btn px-4 py-2 sm:px-6 rounded-md transition" data-category="food">Makanan</button>
                        <button onclick="filterProducts('dessert')" class="category-btn px-4 py-2 sm:px-6 rounded-md transition" data-category="dessert">Dessert</button>
                        <button onclick="filterProducts('other')" class="category-btn px-4 py-2 sm:px-6 rounded-md transition" data-category="other">Lainnya</button>
                    </div>
                </div>

                <div id="productsGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    </div>

            </div>

            <div id="queuePage" class="page-content hidden">
                <h2 class="text-3xl font-bold mb-8 text-center">Antrian Saat Ini</h2>
                <div id="queueList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="contactPage" class="page-content hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold mb-8 text-center">Hubungi Kami</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4">Informasi Kontak</h3>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <span data-icon="address" class="text-theme-primary w-6"></span>
                                    <span id="contactAddress">Jl. Contoh No. 123, Jakarta</span>
                                </div>
                                <div class="flex items-center">
                                    <span data-icon="contact" class="text-theme-primary w-6"></span>
                                    <span id="contactPhone">+62 812-3456-7890</span>
                                </div>
                                <div class="flex items-center">
                                    <span data-icon="email" class="text-theme-primary w-6"></span>
                                    <span id="contactEmail">info@kopiku.com</span>
                                </div>
                                <div class="flex items-center">
                                    <span data-icon="hours" class="text-theme-primary w-6"></span>
                                    <span id="contactHours">Senin - Minggu: 08:00 - 22:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4">Kirim Pesan</h3>
                            <form onsubmit="sendContactMessage(event)" class="space-y-4">
                                <input type="text" placeholder="Nama Anda" class="w-full p-3 border rounded-lg" required>
                                <input type="email" placeholder="Email Anda" class="w-full p-3 border rounded-lg" required>
                                <textarea placeholder="Pesan Anda" rows="4" class="w-full p-3 border rounded-lg" required></textarea>
                                <button type="submit" class="w-full bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                                    <span data-icon="send" class="mr-2"></span>Kirim Pesan
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
             <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-40">
                <nav class="flex justify-around py-2">
                    <button onclick="showPage('home')" class="nav-btn flex flex-col items-center text-gray-600 hover:text-theme-primary transition">
                        <span data-icon="home" class="text-xl"></span><span class="text-xs">Beranda</span>
                    </button>
                    <button onclick="showPage('menu')" class="nav-btn flex flex-col items-center text-gray-600 hover:text-theme-primary transition">
                        <span data-icon="menu" class="text-xl"></span><span class="text-xs">Menu</span>
                    </button>
                    <button onclick="showPage('queue')" class="nav-btn flex flex-col items-center text-gray-600 hover:text-theme-primary transition">
                        <span data-icon="queue" class="text-xl"></span><span class="text-xs">Antrian</span>
                    </button>
                    <button onclick="showPage('contact')" class="nav-btn flex flex-col items-center text-gray-600 hover:text-theme-primary transition">
                        <span data-icon="contact" class="text-xl"></span><span class="text-xs">Kontak</span>
                    </button>
                </nav>
            </div>
        </main>

        <button id="cartFab" onclick="showCartModal()" class="fixed bottom-20 md:bottom-8 right-8 bg-theme-primary text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-theme-primary-hover transition z-30 hidden">
            <span data-icon="cart"></span>
            <span id="cartItemCountBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center hidden">0</span>
        </button>

        <footer class="bg-gray-800 text-white py-8 mt-16 pb-20 md:pb-8">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2025 <span id="footerMerchantName">KopiKu</span>. All rights reserved.</p>
                <div class="mt-4 flex justify-center space-x-4">
                    <a href="#" class="hover:text-theme-primary transition"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="hover:text-theme-primary transition"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="hover:text-theme-primary transition"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
        </footer>
    </div>

    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm slide-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Keranjang</h2>
                <button onclick="closeCartModal()" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modalCartItems" class="mb-4 max-h-64 overflow-y-auto pr-2">
                </div>
            <div class="border-t pt-4">
                <div class="flex justify-between font-bold text-lg mb-4">
                    <span>Total</span>
                    <span id="modalCartTotal">Rp 0</span>
                </div>
                <div class="flex space-x-4">
                    <button onclick="closeCartModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition">
                        Tutup
                    </button>
                    <button onclick="proceedToCheckout()" class="flex-1 bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 w-full max-w-sm slide-in">
            <h2 class="text-2xl font-bold mb-6 text-center">Login Admin</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg" required>
                </div>
                <button type="submit" class="w-full bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>
            <button onclick="closeLoginModal()" class="w-full mt-4 text-gray-600 hover:text-gray-800 transition">
                Batal
            </button>
        </div>
    </div>

    <div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 md:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-in">
            <h2 class="text-2xl font-bold mb-6">Checkout</h2>
            <form onsubmit="processCheckout(event)" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nama Lengkap</label>
                        <input type="text" id="customerName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Nomor Telepon</label>
                        <input type="tel" id="customerPhone" class="w-full p-3 border rounded-lg" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Email (Opsional)</label>
                    <input type="email" id="customerEmail" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Metode Pembayaran</label>
                    <div id="paymentMethods" class="grid grid-cols-2 gap-4">
                        </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Catatan (Opsional)</label>
                    <textarea id="orderNotes" rows="3" class="w-full p-3 border rounded-lg"></textarea>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between text-lg md:text-xl font-bold mb-4">
                        <span>Total Pembayaran:</span>
                        <span id="checkoutTotal">Rp 0</span>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="closeCheckoutModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                            <span data-icon="checkout" class="mr-2"></span>Proses Pesanan
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="adminPanel" class="fixed inset-0 bg-gray-100 z-50 hidden">
        <div class="flex h-screen relative">
            <div id="adminSidebar" class="absolute inset-y-0 left-0 w-64 bg-gray-800 text-white transform -translate-x-full md:relative md:translate-x-0 transition-all duration-300 ease-in-out z-30">
                <div class="p-4">
                    <h2 class="text-xl font-bold mb-6">Admin Panel</h2>
                    <nav class="space-y-2">
                        <button onclick="showAdminSection('dashboard')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-tachometer-alt mr-2"></i><span class="nav-text">Dashboard</span>
                        </button>
                        <button onclick="showAdminSection('orders')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-shopping-cart mr-2"></i><span class="nav-text">Pesanan</span>
                        </button>
                        <button onclick="showAdminSection('queue')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-users mr-2"></i><span class="nav-text">Antrian</span>
                        </button>
                        <button onclick="showAdminSection('products')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-box mr-2"></i><span class="nav-text">Produk</span>
                        </button>
                        <button onclick="showAdminSection('users')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-user-cog mr-2"></i><span class="nav-text">Pengguna</span>
                        </button>
                        <button onclick="showAdminSection('settings')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-cog mr-2"></i><span class="nav-text">Pengaturan</span>
                        </button>
                        <button onclick="showAdminSection('reports')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-chart-bar mr-2"></i><span class="nav-text">Laporan</span>
                        </button>
                        <button onclick="showAdminSection('database')" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-database mr-2"></i><span class="nav-text">Database</span>
                        </button>
                        <button onclick="logoutAdmin()" class="admin-nav-btn w-full flex items-center justify-start p-3 rounded hover:bg-red-600 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i><span class="nav-text">Logout</span>
                        </button>
                    </nav>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto">
                 <div class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
                    <button id="sidebarToggle" class="text-gray-800">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h1 class="font-bold text-lg" id="adminSectionTitle">Dashboard</h1>
                </div>

                <div class="p-6">
                    <div id="adminDashboard" class="admin-section">
                        <h1 class="text-3xl font-bold mb-6 hidden md:block">Dashboard</h1>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                           <div onclick="showAdminSection('orders')" class="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-xl transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600">Total Pesanan</p>
                                        <p class="text-2xl font-bold" id="totalOrders">0</p>
                                    </div>
                                    <i class="fas fa-shopping-cart text-theme-primary text-2xl"></i>
                                </div>
                            </div>
                            <div onclick="showAdminSection('queue')" class="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-xl transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600">Antrian Aktif</p>
                                        <p class="text-2xl font-bold" id="activeQueue">0</p>
                                    </div>
                                    <i class="fas fa-users text-blue-600 text-2xl"></i>
                                </div>
                            </div>
                            <div onclick="showAdminSection('products')" class="bg-white p-6 rounded-lg shadow cursor-pointer hover:shadow-xl transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600">Total Produk</p>
                                        <p class="text-2xl font-bold" id="totalProducts">0</p>
                                    </div>
                                    <i class="fas fa-box text-green-600 text-2xl"></i>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600">Pendapatan</p>
                                        <p class="text-2xl font-bold" id="totalRevenue">Rp 0</p>
                                    </div>
                                    <i class="fas fa-money-bill text-yellow-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="adminOrders" class="admin-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold hidden md:block">Manajemen Pesanan</h1>
                            <button onclick="exportOrdersReport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Pesanan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pelanggan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                        <div id="adminOrdersPagination" class="mt-4 flex flex-col sm:flex-row justify-between items-center w-full gap-2"></div>
                    </div>

                    <div id="adminQueue" class="admin-section hidden">
                        <h1 class="text-3xl font-bold mb-6 hidden md:block">Manajemen Antrian</h1>
                        <div id="adminQueueList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </div>
                    </div>

                    <div id="adminProducts" class="admin-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold hidden md:block">Manajemen Produk</h1>
                            <button onclick="showProductModal()" class="bg-theme-primary text-white px-4 py-2 rounded-lg hover:bg-theme-primary-hover transition">
                                <i class="fas fa-plus mr-2"></i>Tambah
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Produk</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Harga</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProductsTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <div id="adminProductsPagination" class="mt-4 flex flex-col sm:flex-row justify-between items-center w-full gap-2">
                        </div>
                    </div>

                    <div id="adminUsers" class="admin-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold hidden md:block">Manajemen Pengguna</h1>
                            <button onclick="showUserModal()" class="bg-theme-primary text-white px-4 py-2 rounded-lg hover:bg-theme-primary-hover transition">
                                <i class="fas fa-plus mr-2"></i>Tambah
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                        <div id="adminUsersPagination" class="mt-4 flex flex-col sm:flex-row justify-between items-center w-full gap-2"></div>
                    </div>

                    <div id="adminSettings" class="admin-section hidden">
                        <h1 class="text-3xl font-bold mb-6 hidden md:block">Pengaturan</h1>
                        <div class="bg-white rounded-lg shadow p-6">
                            <form onsubmit="saveSettings(event)" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Nama Merchant</label>
                                    <input type="text" id="settingsMerchantName" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Jumbotron Title</label>
                                    <input type="text" id="settingsJumbotronTitle" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Jumbotron Subtitle</label>
                                    <input type="text" id="settingsJumbotronSubtitle" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Alamat</label>
                                    <input type="text" id="settingsAddress" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Telepon</label>
                                    <input type="text" id="settingsPhone" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="settingsEmail" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Jam Operasional</label>
                                    <input type="text" id="settingsHours" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Metode Pembayaran Aktif</label>
                                    <div id="settingsPaymentMethods" class="space-y-2">
                                        </div>
                                </div>

                                <div class="border-t pt-6">
                                    <label class="block text-lg font-semibold mb-4">Tema Warna</label>
                                    <div class="flex flex-wrap items-center gap-4">
                                        <button type="button" onclick="applyTheme('purple')" class="w-8 h-8 rounded-full bg-purple-500 border-2 border-white shadow"></button>
                                        <button type="button" onclick="applyTheme('brown')" class="w-8 h-8 rounded-full bg-amber-700 border-2 border-white shadow"></button>
                                        <button type="button" onclick="applyTheme('red')" class="w-8 h-8 rounded-full bg-red-600 border-2 border-white shadow"></button>
                                        <button type="button" onclick="applyTheme('black')" class="w-8 h-8 rounded-full bg-gray-800 border-2 border-white shadow"></button>
                                        
                                        <div class="relative">
                                            <label for="customColorPicker" class="cursor-pointer">
                                                <div class="w-8 h-8 rounded-full border-2 border-white shadow flex items-center justify-center bg-gray-200">
                                                    <i class="fas fa-palette"></i>
                                                </div>
                                                <input type="color" id="customColorPicker" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                                            </label>
                                            <span class="ml-2 text-sm text-gray-600">Kustom</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="border-t pt-6">
                                    <label class="block text-lg font-semibold mb-4">Ikon Halaman Utama</label>
                                    <button type="button" onclick="showIconModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                        <i class="fas fa-palette mr-2"></i>Ubah Ikon Individual
                                    </button>
                                </div>
                                
                                <button type="submit" class="bg-theme-primary text-white px-6 py-3 rounded-lg hover:bg-theme-primary-hover transition">
                                    <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="adminReports" class="admin-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold hidden md:block">Laporan</h1>
                            <button onclick="exportOrdersReport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <div id="reportContent">
                                </div>
                        </div>
                    </div>
                    
                    <div id="adminDatabase" class="admin-section hidden">
                        <h1 class="text-3xl font-bold hidden md:block">Manajemen Database</h1>
                        <div class="bg-white rounded-lg shadow p-6 space-y-6">
                            <h3 class="text-xl font-semibold mb-4">Aksi Database</h3>
                            
                            <div class="border p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Download Database (Export)</h4>
                                <p class="text-sm text-gray-600 mb-3">Unduh seluruh data aplikasi ke dalam file JSON (.json).</p>
                                <button onclick="downloadDatabase()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-download mr-2"></i>Download DB (.json)
                                </button>
                            </div>

                            <div class="border p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Import Database</h4>
                                <p class="text-sm text-gray-600 mb-3">Unggah data aplikasi dari file JSON (.json) yang sudah ada. Ini akan menimpa data saat ini.</p>
                                <input type="file" id="importDbFile" accept=".json" class="hidden" onchange="handleImportDatabase(event)">
                                <button onclick="document.getElementById('importDbFile').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-upload mr-2"></i>Pilih File Database
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 md:p-8 w-full max-w-2xl slide-in max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6" id="productModalTitle">Tambah Produk</h2>
            <form onsubmit="saveProduct(event)" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nama Produk</label>
                        <input type="text" id="productName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Kategori</label>
                        <select id="productCategory" class="w-full p-3 border rounded-lg" required>
                            <option value="coffee">Kopi</option>
                            <option value="food">Makanan</option>
                            <option value="dessert">Dessert</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Deskripsi</label>
                    <textarea id="productDescription" rows="3" class="w-full p-3 border rounded-lg"></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Harga</label>
                        <input type="number" id="productPrice" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <select id="productStatus" class="w-full p-3 border rounded-lg">
                            <option value="true">Tersedia</option>
                            <option value="false">Tidak Tersedia</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 w-full max-w-md slide-in">
            <h2 class="text-2xl font-bold mb-6" id="userModalTitle">Tambah Admin</h2>
            <form onsubmit="saveUser(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nama Lengkap</label>
                    <input type="text" id="userFullName" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="userUsername" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="userPassword" class="w-full p-3 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Role</label>
                    <select id="userRole" class="w-full p-3 border rounded-lg">
                        <option value="admin">Admin</option>
                        <option value="superadmin">Super Admin</option>
                    </select>
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="closeUserModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-theme-primary text-white py-3 rounded-lg hover:bg-theme-primary-hover transition">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 md:bottom-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-4 flex items-center space-x-3 slide-in">
            <div id="toastIcon"></div>
            <div>
                <p id="toastTitle" class="font-semibold"></p>
                <p id="toastMessage" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        // Global Templates for easy selection
        const ICON_TEMPLATES = {
            // Kopi & Makanan
            'fas fa-coffee': 'Kopi Klasik',
            'fas fa-mug-hot': 'Mug Panas',
            'fas fa-carrot': 'Sayuran/Wortel',
            'fas fa-leaf': 'Daun/Alam',
            'fas fa-utensils': 'Alat Makan/Food',
            
            // Produk & Penjualan
            'fas fa-box': 'Kotak/Produk',
            'fas fa-boxes-packing': 'Box Banyak',
            'fas fa-shopping-basket': 'Keranjang/Basket',
            'fas fa-cart-shopping': 'Troli Belanja',
            'fas fa-bag-shopping': 'Tas Belanja',
            'fas fa-money-bill-wave': 'Uang/Pembayaran',
            'fas fa-store': 'Toko/Jual',
            
            // Administrasi & Informasi
            'fas fa-home': 'Rumah/Beranda',
            'fas fa-database': 'Database',
            'fas fa-list-check': 'Checklist/Daftar',
            'fas fa-clipboard-check': 'Checklist Papan',
            'fas fa-users': 'Antrian/Pengguna',
            'fas fa-plus': 'Tambah/Add',
            'fas fa-book-open': 'Buku/Menu',
            
            // Teknologi & Lainnya
            'fas fa-wifi': 'WiFi',
            'fas fa-couch': 'Sofa/Nyaman',
            'fas fa-mobile-screen-button': 'Ponsel/Mobile',
            'fas fa-square-phone': 'Ponsel Kotak',
            'fas fa-laptop': 'Komputer/Laptop',
            'fas fa-desktop': 'Desktop',
            'fas fa-robot': 'AI/Robot',
            'fas fa-medal': 'Medali',
            'fas fa-ribbon': 'Pita Penghargaan',
            
            // Kontak & Lokasi
            'fas fa-map-marker-alt': 'Alamat',
            'fas fa-envelope': 'Email',
            'fas fa-clock': 'Jam Operasi',
            'fas fa-phone': 'Telepon/Kontak',
            'fas fa-paper-plane': 'Kirim Pesan',
            'fas fa-check': 'Cek/Selesai',
        };

        // --- NEW ---
        // Global variable to hold all database data in memory
        let dbData = {};

        async function loadDatabase() {
            try {
                const response = await fetch('database.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                dbData = await response.json();
            } catch (error) {
                console.error("Could not load database:", error);
                // Fallback to an empty structure if loading fails
                dbData = { settings: {}, products: [], orders: [], queue: [], users: [], messages: [] };
                showToast('error', 'Gagal Memuat', 'Tidak dapat memuat database.json.');
            }
        }
        // --- END NEW ---

        let currentUser = null;
        let cart = [];
        let currentFilter = 'all';
        let editingProductId = null;
        let editingUserId = null;
        
        const itemsPerPage = 10;
        let productsCurrentPage = 1;
        let ordersCurrentPage = 1;
        let usersCurrentPage = 1;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDatabase(); // Load data from JSON first
            
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                initializeApp();
            }, 500); // Short delay to ensure UI elements are ready
            
            const adminContent = document.querySelector('#adminPanel .flex-1.overflow-y-auto');
            const sidebar = document.getElementById('adminSidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            
            if (toggleButton) {
                toggleButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const sidebarTitle = sidebar.querySelector('h2');
                    const navButtons = sidebar.querySelectorAll('.admin-nav-btn');

                    if (window.innerWidth < 768) {
                        sidebar.classList.toggle('-translate-x-full');
                    } else {
                        sidebar.classList.toggle('w-64');
                        sidebar.classList.toggle('w-20');
                        sidebarTitle.classList.toggle('hidden');

                        navButtons.forEach(btn => {
                            const icon = btn.querySelector('i');
                            const text = btn.querySelector('.nav-text');
                            text.classList.toggle('hidden');
                            icon.classList.toggle('mr-2');
                            btn.classList.toggle('justify-start');
                            btn.classList.toggle('justify-center');
                        });
                    }
                });
            }

            if(adminContent) {
                adminContent.addEventListener('click', () => {
                    if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.add('-translate-x-full');
                    }
                });
            }

            const customColorPicker = document.getElementById('customColorPicker');
            if (customColorPicker) {
                customColorPicker.addEventListener('input', (event) => {
                    applyCustomTheme(event.target.value);
                });
            }
        });

        function initializeApp() {
            loadTheme();
            applyIconTheme(); 
            loadSettings();
            loadProducts();
            loadQueue();
            updateCart();
            
            const isAdminLoggedIn = localStorage.getItem('kopiku_is_admin') === 'true';
            const lastPage = localStorage.getItem('kopiku_current_page') || 'home';
            
            if (isAdminLoggedIn) {
                document.getElementById('adminPanel').classList.remove('hidden');
                const lastAdminSection = localStorage.getItem('kopiku_admin_section') || 'dashboard';
                showAdminSection(lastAdminSection);
                loadAdminData();
            } else {
                showPage(lastPage);
            }

            setInterval(function() {
                const isAdminOpen = !document.getElementById('adminPanel').classList.contains('hidden');

                if (isAdminOpen) {
                    const isAdminQueueActive = !document.getElementById('adminQueue').classList.contains('hidden');
                    if (isAdminQueueActive) {
                        loadAdminQueue();
                    }
                } else if (!document.getElementById('queuePage').classList.contains('hidden')) {
                    loadQueue();
                }
            }, 5000); 
        }

        const themes = {
            purple: { primary: '#8B5CF6', hover: '#7C3AED', text: '#8B5CF6', from: '#8B5CF6', to: '#2563EB' },
            brown: { primary: '#a16207', hover: '#854d0e', text: '#a16207', from: '#a16207', to: '#b45309' },
            red: { primary: '#dc2626', hover: '#b91c1c', text: '#dc2626', from: '#dc2626', to: '#ef4444' },
            black: { primary: '#1f2937', hover: '#111827', text: '#1f2937', from: '#1f2937', to: '#4b5563' }
        };

        function setCssVariables(colors) {
            const root = document.documentElement;
            root.style.setProperty('--theme-primary', colors.primary);
            root.style.setProperty('--theme-primary-hover', colors.hover);
            root.style.setProperty('--theme-text', colors.text);
            root.style.setProperty('--theme-gradient-from', colors.from);
            root.style.setProperty('--theme-gradient-to', colors.to);
        }

        function applyTheme(themeName) {
            const themeColors = themes[themeName];
            if (themeColors) {
                setCssVariables(themeColors);
                dbData.settings.theme = themeName;
            }
        }
        
        function generateColorShades(hex) {
            let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            const darken = (c) => Math.max(0, Math.floor(c * 0.85)).toString(16).padStart(2, '0');
            const shift = (c1, c2) => Math.min(255, Math.floor(c1 * 1.2 + c2 * 0.2)).toString(16).padStart(2, '0');
            return {
                primary: hex,
                hover: `#${darken(r)}${darken(g)}${darken(b)}`,
                text: hex,
                from: hex,
                to: `#${shift(r,b)}${shift(g,r)}${shift(b,g)}`
            };
        }

        function applyCustomTheme(hexColor) {
            const shades = generateColorShades(hexColor);
            setCssVariables(shades);
            dbData.settings.theme = hexColor;
        }

        function loadTheme() {
            if(!dbData.settings.theme) dbData.settings.theme = 'purple';
            const savedTheme = dbData.settings.theme;
            if (savedTheme.startsWith('#')) {
                applyCustomTheme(savedTheme);
                document.getElementById('customColorPicker').value = savedTheme;
            } else {
                applyTheme(savedTheme);
            }
        }
        
        function applyIconTheme() {
            const customIcons = dbData.settings.customIcons || {};
            const iconMap = {
                'coffee-cup': 'fas fa-coffee', 'wifi': 'fas fa-wifi', 'couch': 'fas fa-couch',
                'home': 'fas fa-home', 'menu': 'fas fa-mug-hot', 'queue': 'fas fa-users', 
                'contact': 'fas fa-phone', 'admin': 'fas fa-user-shield', 'cart': 'fas fa-shopping-cart',
                'address': 'fas fa-map-marker-alt', 'email': 'fas fa-envelope', 'hours': 'fas fa-clock',
                'send': 'fas fa-paper-plane', 'checkout': 'fas fa-check', 'add': 'fas fa-plus',
                ...customIcons 
            };
            
            document.querySelectorAll('[data-icon]').forEach(el => {
                const iconName = el.getAttribute('data-icon');
                const faClass = iconMap[iconName] || 'fas fa-question-circle'; 
                el.innerHTML = `<i class="${faClass}"></i>`;
            });
        }

        function showIconModal() {
            loadIconForm();
            document.getElementById('iconModal').classList.remove('hidden');
        }

        function closeIconModal() {
            document.getElementById('iconModal').classList.add('hidden');
        }

        function loadIconForm() {
            const customIcons = dbData.settings.customIcons;
            const container = document.getElementById('iconFormFields');
            container.innerHTML = '';

            const iconLabels = {
                'coffee-cup': 'Ikon Kopi/Logo', 'wifi': 'Ikon WiFi', 'couch': 'Ikon Ruangan Nyaman',
                'home': 'Ikon Beranda (Menu)', 'menu': 'Ikon Menu', 'queue': 'Ikon Antrian',
                'contact': 'Ikon Kontak/Telepon', 'admin': 'Ikon Tombol Admin', 'cart': 'Ikon Keranjang (FAB)',
                'address': 'Ikon Alamat', 'email': 'Ikon Email', 'hours': 'Ikon Jam Operasional',
                'send': 'Ikon Kirim Pesan', 'checkout': 'Ikon Proses Pesanan', 'add': 'Ikon Tambah ke Keranjang'
            };

            for (const key in customIcons) {
                const label = iconLabels[key] || key;
                const currentValue = customIcons[key];
                let optionsHtml = '';
                
                for (const faClass in ICON_TEMPLATES) {
                    const isChecked = faClass === currentValue ? 'checked' : '';
                    const iconName = ICON_TEMPLATES[faClass];
                    
                    optionsHtml += `
                        <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="icon_select_${key}" value="${faClass}" class="form-radio text-theme-primary" ${isChecked} 
                                onclick="document.querySelector('#icon-preview-${key} i').className = this.value">
                            <span class="ml-3 flex-1 text-sm">${iconName}</span>
                            <i class="${faClass} text-xl text-gray-500 w-6 text-center"></i>
                        </label>
                    `;
                }

                container.innerHTML += `
                    <div class="space-y-3 bg-white p-4 rounded-lg shadow-md">
                        <label class="block text-lg font-semibold">${label}</label>
                        <div class="flex items-center space-x-4 mb-2">
                            <p class="text-gray-600 text-sm">Pratinjau Saat Ini:</p>
                            <span id="icon-preview-${key}" class="text-theme-primary text-2xl">
                                <i class="${currentValue}"></i>
                            </span>
                        </div>
                        <div class="grid grid-cols-1 gap-2 max-h-64 overflow-y-auto border p-2 bg-gray-50">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            }
        }

        function saveIconCustomization(event) {
            event.preventDefault();
            const newIcons = {};
            const iconKeys = Object.keys(dbData.settings.customIcons);
            
            iconKeys.forEach(key => {
                const selectedRadio = document.querySelector(`input[name="icon_select_${key}"]:checked`);
                if (selectedRadio) {
                    newIcons[key] = selectedRadio.value;
                } else {
                    newIcons[key] = dbData.settings.customIcons[key];
                }
            });

            dbData.settings.customIcons = newIcons;
            applyIconTheme(); 
            closeIconModal();
            showToast('success', 'Berhasil', 'Ikon telah diperbarui!');
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            document.body.scrollTop = 0; 
            document.documentElement.scrollTop = 0; 
            setActiveNav(pageId);
            localStorage.setItem('kopiku_current_page', pageId);
            localStorage.removeItem('kopiku_is_admin');
        }

        function setActiveNav(pageId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-theme-primary');
                btn.classList.add('text-gray-600');
                if (btn.querySelector('span')) {
                    const mobilePageId = btn.querySelector('span').textContent.toLowerCase();
                     if(mobilePageId.includes(pageId) || (pageId === 'home' && mobilePageId.includes('beranda'))) {
                        btn.classList.remove('text-gray-600');
                        btn.classList.add('text-theme-primary');
                     }
                } else {
                    if (btn.textContent.toLowerCase().includes(pageId) || 
                        (pageId === 'home' && btn.textContent.includes('Beranda')) ||
                        (pageId === 'menu' && btn.textContent.includes('Menu')) ||
                        (pageId === 'queue' && btn.textContent.includes('Antrian')) ||
                        (pageId === 'contact' && btn.textContent.includes('Kontak'))) {
                        btn.classList.remove('text-gray-600');
                        btn.classList.add('text-theme-primary');
                    }
                }
            });
        }

        function loadSettings() {
            const settings = dbData.settings;
            document.title = settings.merchantName;
            document.getElementById('merchantName').textContent = settings.merchantName;
            document.getElementById('jumbotronTitle').textContent = settings.jumbotronTitle;
            document.getElementById('jumbotronSubtitle').textContent = settings.jumbotronSubtitle;
            document.getElementById('contactAddress').textContent = settings.address;
            document.getElementById('contactPhone').textContent = settings.phone;
            document.getElementById('contactEmail').textContent = settings.email;
            document.getElementById('contactHours').textContent = settings.hours;
            document.getElementById('footerMerchantName').textContent = settings.merchantName;
        }

        function loadProducts() {
            const products = dbData.products;
            const featuredContainer = document.getElementById('featuredProducts');
            featuredContainer.innerHTML = '';
            products.slice(0, 4).forEach(product => {
                featuredContainer.innerHTML += createProductCard(product);
            });
            const productsContainer = document.getElementById('productsGrid');
            productsContainer.innerHTML = '';
            products.forEach(product => {
                productsContainer.innerHTML += createProductCard(product);
            });
            applyIconTheme();
        }

        function createProductCard(product) {
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover-scale product-card cursor-pointer" 
                     data-category="${product.category}" 
                     onclick="addToCart(${product.id})">
                    <div class="h-48 gradient-theme flex items-center justify-center">
                        <span data-icon="coffee-cup" class="text-white text-4xl"></span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-3 h-10 overflow-hidden">${product.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-theme-primary font-bold">Rp ${product.price.toLocaleString()}</span>
                            <button onclick="event.stopPropagation(); addToCart(${product.id})" 
                                    class="bg-theme-primary text-white px-3 py-1 rounded-lg hover:bg-theme-primary-hover transition ${!product.available ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    ${!product.available ? 'disabled' : ''}>
                                <span data-icon="add"></span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterProducts(category) {
            currentFilter = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-theme-primary', 'text-white');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.querySelector(`[data-category="${category}"]`);
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('bg-theme-primary', 'text-white');
        }

        function showCartModal() {
            const modal = document.getElementById('cartModal');
            const cartItemsContainer = document.getElementById('modalCartItems');
            const cartTotalEl = document.getElementById('modalCartTotal');
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500">Keranjang kosong</p>';
                cartTotalEl.textContent = 'Rp 0';
            } else {
                let html = '';
                let total = 0;
                cart.forEach(item => {
                    html += `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex-1">
                                <p class="font-semibold text-sm">${item.name}</p>
                                <p class="text-xs text-gray-600">Rp ${item.price.toLocaleString()} x ${item.quantity}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity(${item.id}, -1, true)" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-minus-circle"></i>
                                </button>
                                <span class="text-sm">${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, 1, true)" class="text-green-500 hover:text-green-700">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    total += item.price * item.quantity;
                });
                cartItemsContainer.innerHTML = html;
                cartTotalEl.textContent = `Rp ${total.toLocaleString()}`;
            }

            modal.classList.remove('hidden');
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.add('hidden');
        }

        function proceedToCheckout() {
            if (cart.length === 0) {
                showToast('error', 'Error', 'Keranjang belanja kosong');
                return;
            }
            closeCartModal();
            showCheckoutModal();
        }

        function addToCart(productId) {
            const product = dbData.products.find(p => p.id === productId);
            if (!product || !product.available) {
                showToast('error', 'Maaf', 'Produk sedang tidak tersedia');
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCart();
            showToast('success', 'Berhasil', 'Produk ditambahkan ke keranjang');
        }

        function updateCart() {
            const badge = document.getElementById('cartItemCountBadge');
            const fab = document.getElementById('cartFab');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.classList.remove('hidden');
                fab.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                fab.classList.add('hidden');
            }
        }
        
        function updateQuantity(productId, change, isFromModal = false) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(item => item.id !== productId);
                }
                updateCart();
                if (isFromModal) {
                    showCartModal();
                }
            }
        }

        function showCheckoutModal() {
            if (cart.length === 0) {
                showToast('error', 'Error', 'Keranjang belanja kosong');
                return;
            }
            
            const modal = document.getElementById('checkoutModal');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('checkoutTotal').textContent = `Rp ${total.toLocaleString()}`;
            
            const paymentMethods = document.getElementById('paymentMethods');
            paymentMethods.innerHTML = '';
            
            dbData.settings.paymentMethods.filter(pm => pm.active).forEach(method => {
                paymentMethods.innerHTML += `
                    <label class="flex items-center space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="${method.id}" class="form-radio" required>
                        <i class="fas ${method.icon} text-theme-primary"></i>
                        <span>${method.name}</span>
                    </label>
                `;
            });
            
            modal.classList.remove('hidden');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.add('hidden');
        }

        function processCheckout(event) {
            event.preventDefault(); 
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.dataset.originalHtml = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
            }
            
            try {
                const order = {
                    id: Date.now(),
                    orderNumber: `ORD${Date.now()}`,
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    customerEmail: document.getElementById('customerEmail').value,
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                    notes: document.getElementById('orderNotes').value,
                    items: [...cart],
                    totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                dbData.orders.push(order);
                cart = [];
                updateCart();
                closeCheckoutModal();
                showToast('success', 'Berhasil', `Pesanan ${order.orderNumber} telah dibuat. Silakan tunggu konfirmasi.`);

            } catch (error) {
                showToast('error', 'Kesalahan', 'Terjadi kesalahan saat memproses checkout.');
                console.error("Checkout Error:", error);

                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = submitButton.dataset.originalHtml;
                }
            }
        }

        function generateQueueNumber() {
            const activeQueue = dbData.queue.filter(q => q.status === 'waiting' || q.status === 'called');
            if (activeQueue.length === 0) return 'A001';
            const allQueuesSorted = dbData.queue.sort((a, b) => b.id - a.id);
            const lastQueue = allQueuesSorted[0];
            if (!lastQueue) return 'A001';
            const lastNumber = parseInt(lastQueue.queueNumber.substring(1));
            return `A${String(lastNumber + 1).padStart(3, '0')}`;
        }

        function loadQueue() {
            const queue = dbData.queue.sort((a, b) => a.id - b.id);
            const queueList = document.getElementById('queueList');
            queueList.innerHTML = '';

            const statusTextMap = {
                'waiting': 'Pesanan sedang dibuat', 'called': 'Silakan ambil pesanan anda', 
                'completed': 'Pesanan Selesai Diambil', 'cancelled': 'Dibatalkan', 
                'paid': 'Menunggu Proses Pembuatan', 'pending': 'Menunggu Konfirmasi Pembayaran' 
            };
            
            if (queue.length === 0) {
                queueList.innerHTML = '<p class="text-center text-gray-500 col-span-full">Tidak ada antrian saat ini</p>';
                return;
            }
            
            queue.forEach(item => {
                const statusColor = {
                    'waiting': 'bg-yellow-100 text-yellow-800', 'called': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800', 'cancelled': 'bg-red-100 text-red-800',
                    'paid': 'bg-gray-400 text-white', 'pending': 'bg-gray-100 text-gray-800'
                }[item.status] || 'bg-gray-100 text-gray-800';
                const statusText = statusTextMap[item.status] || item.status;
                
                queueList.innerHTML += `
                    <div class="bg-white rounded-lg shadow-lg p-6 hover-scale">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-theme-primary">${item.queueNumber}</h3>
                                <p class="font-semibold">${item.customerName}</p>
                                <p class="text-gray-600 text-sm">${item.customerPhone}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor}">${statusText}</span>
                        </div>
                        <div class="text-sm text-gray-500"><p>${new Date(item.createdAt).toLocaleString('id-ID')}</p></div>
                    </div>
                `;
            });
        }
        
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = dbData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('kopiku_is_admin', 'true');
                closeLoginModal();
                showAdminPanel();
                showToast('success', 'Login Berhasil', `Selamat datang, ${user.fullName}`);
            } else {
                showToast('error', 'Login Gagal', 'Username atau password salah');
            }
        }

        function showAdminPanel() {
            document.getElementById('adminPanel').classList.remove('hidden');
            const lastAdminSection = localStorage.getItem('kopiku_admin_section') || 'dashboard';
            showAdminSection(lastAdminSection); 
            loadAdminData();
            localStorage.setItem('kopiku_is_admin', 'true');
        }

        function logoutAdmin() {
            currentUser = null;
            localStorage.removeItem('kopiku_is_admin');
            localStorage.removeItem('kopiku_admin_section');
            document.getElementById('adminPanel').classList.add('hidden');
            showToast('success', 'Logout Berhasil', 'Anda telah keluar dari panel admin');
            showPage(localStorage.getItem('kopiku_current_page') || 'home'); 
        }

        function showAdminSection(section) {
            localStorage.setItem('kopiku_admin_section', section);
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
            const sectionEl = document.getElementById('admin' + section.charAt(0).toUpperCase() + section.slice(1));
            sectionEl.classList.remove('hidden');
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('bg-gray-700'));
            const clickedBtn = Array.from(document.querySelectorAll('.admin-nav-btn')).find(btn => btn.getAttribute('onclick').includes(section));
            if(clickedBtn) {
                 clickedBtn.classList.add('bg-gray-700');
            }
            document.getElementById('adminSectionTitle').textContent = clickedBtn.querySelector('.nav-text').textContent.trim();
            loadAdminSectionData(section);
            const sidebar = document.getElementById('adminSidebar');
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        function loadAdminData() {
            document.getElementById('totalOrders').textContent = dbData.orders.length;
            document.getElementById('activeQueue').textContent = dbData.queue.filter(q => q.status === 'waiting' || q.status === 'called').length;
            document.getElementById('totalProducts').textContent = dbData.products.length;
            const totalRevenue = dbData.orders
                .filter(o => o.status === 'paid' || o.status === 'completed' || o.status === 'waiting')
                .reduce((sum, o) => sum + o.totalAmount, 0);
            document.getElementById('totalRevenue').textContent = `Rp ${totalRevenue.toLocaleString()}`;
        }

        function loadAdminSectionData(section) {
            switch(section) {
                case 'orders': ordersCurrentPage = 1; loadOrdersTable(); break;
                case 'queue': loadAdminQueue(); break;
                case 'products': productsCurrentPage = 1; loadAdminProducts(); break;
                case 'users': usersCurrentPage = 1; loadUsersTable(); break;
                case 'settings': loadSettingsForm(); break;
                case 'reports': loadReportsSection(); break;
            }
        }
        
	function loadOrdersTable() {
            const orders = dbData.orders.sort((a, b) => b.id - a.id);
            const ordersTable = document.getElementById('ordersTable');
            ordersTable.innerHTML = '';

            const startIndex = (ordersCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedOrders = orders.slice(startIndex, endIndex);

            paginatedOrders.forEach(order => {
                const statusColor = {
                    'pending': 'bg-yellow-100 text-yellow-800', 'paid': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800', 'cancelled': 'bg-red-100 text-red-800',
                    'waiting': 'bg-purple-100 text-purple-800'
                }[order.status] || 'bg-gray-100 text-gray-800';
                const statusTextMap = {
                    'pending': 'pending', 'paid': 'dibayar', 'completed': 'selesai',
                    'cancelled': 'dibatalkan', 'waiting': 'antrian'
                };
                const statusText = statusTextMap[order.status] || order.status;
                
                ordersTable.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${order.orderNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${order.customerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">Rp ${order.totalAmount.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${statusText}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex space-x-4 items-center">
                                ${order.status === 'pending' ? `<button onclick="confirmPayment(${order.id})" class="text-green-600 hover:text-green-800 p-2" title="Konfirmasi Pembayaran"><i class="fas fa-check"></i></button>` : ''}
                                ${order.status === 'paid' ? `<button onclick="addToQueue(${order.id})" class="text-blue-600 hover:text-blue-800 p-2" title="Tambahkan ke Antrian"><i class="fas fa-users"></i></button>` : ''}
                                ${order.status === 'waiting' ? `<button onclick="callCustomer(${order.id})" class="text-purple-600 hover:text-purple-800 p-2" title="Panggil Pelanggan"><i class="fas fa-bullhorn"></i></button>` : ''}
                                ${order.status === 'completed' ? `<button onclick="printReceipt(${order.id})" class="text-blue-600 hover:text-blue-800 p-2" title="Cetak Struk"><i class="fas fa-print"></i></button>` : ''}
                                <button onclick="deleteOrder(${order.id})" class="text-red-600 hover:text-red-800 p-2" title="Hapus Pesanan"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            renderOrdersPagination(orders.length);
        }

        function renderOrdersPagination(totalItems) {
            const paginationContainer = document.getElementById('adminOrdersPagination');
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;
            paginationContainer.innerHTML = `
                <button onclick="changeOrdersPage(-1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${ordersCurrentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                <span class="text-sm font-semibold my-2 sm:my-0">Halaman ${ordersCurrentPage} dari ${totalPages}</span>
                <button onclick="changeOrdersPage(1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${ordersCurrentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
            `;
        }

        function changeOrdersPage(direction) {
            ordersCurrentPage += direction;
            loadOrdersTable();
        }

        function confirmPayment(orderId) {
            const order = dbData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'paid'; 
                loadOrdersTable();
                loadAdminData();
                showToast('success', 'Berhasil', 'Pembayaran telah dikonfirmasi');
            }
        }

        function addToQueue(orderId) {
            const order = dbData.orders.find(o => o.id === orderId);
            if (order && order.status === 'paid') {
                const existingQueueItem = dbData.queue.find(q => q.orderId === orderId);
                if (existingQueueItem) {
                    showToast('warning', 'Sudah Ada', 'Pesanan sudah berada di antrian.');
                    return;
                }
                const queueItem = {
                    id: Date.now(), queueNumber: generateQueueNumber(), orderId: order.id,
                    customerName: order.customerName, customerPhone: order.customerPhone,
                    status: 'waiting', createdAt: new Date().toISOString()
                };
                dbData.queue.push(queueItem);
                order.status = 'waiting'; 
                loadOrdersTable();
                loadAdminQueue();
                loadAdminData(); 
                showToast('success', 'Berhasil', 'Pesanan ditambahkan ke antrian');
            }
        }

        function callCustomer(orderId) {
            const order = dbData.orders.find(o => o.id === orderId);
            const queueItem = dbData.queue.find(q => q.orderId === orderId);
            if (queueItem && order) {
                const customerName = order.customerName;
                const queueNumber = queueItem.queueNumber.replace('A', 'A '); 
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(`Nomor antrian ${queueNumber}, atas nama ${customerName}, silakan ambil pesanan Anda.`);
                    utterance.lang = 'id-ID'; 
                    utterance.rate = 0.9; 
                    utterance.pitch = 1.2; 
                    window.speechSynthesis.speak(utterance);
                    showToast('info', 'Memanggil', `Memanggil: Nomor ${queueItem.queueNumber} (${customerName})`);
                } else {
                    showToast('warning', 'Peringatan', 'Browser tidak mendukung fitur pemanggilan suara.');
                }
                queueItem.status = 'called';
                loadAdminQueue();
            }
        }

        function printReceipt(orderId) {
            const order = dbData.orders.find(o => o.id === orderId);
            const settings = dbData.settings;
            if (!order) {
                showToast('error', 'Gagal', 'Pesanan tidak ditemukan.');
                return;
            }
            const receiptDate = new Date(order.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
            const paymentMethodName = dbData.settings.paymentMethods.find(p => p.id === order.paymentMethod)?.name || order.paymentMethod;
            let itemsHtml = order.items.map(item => `<tr class="text-sm"><td>${item.name}</td><td class="text-right">x ${item.quantity}</td><td class="text-right">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</td></tr>`).join('');
            const printContent = `
                <!DOCTYPE html><html><head><title>Struk ${order.orderNumber}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><style>body { font-family: 'Courier New', monospace; font-size: 12px; max-width: 80mm; margin: 0 auto; padding: 10px; } .receipt { width: 100%; border-collapse: collapse; } .receipt th, .receipt td { padding: 3px 0; } .header { text-align: center; margin-bottom: 10px; } .separator { border-top: 1px dashed #000; margin: 5px 0; padding: 5px 0; } .text-right { text-align: right; } .text-left { text-align: left; } .text-center { text-align: center; } @media print { body { margin: 0; padding: 0; } }</style></head>
                <body><div class="header"><h3>${settings.merchantName}</h3><p>${settings.address}</p><p>Tel: ${settings.phone}</p></div><div class="separator"></div><p>No. Pesanan: ${order.orderNumber}</p><p>Pelanggan: ${order.customerName}</p><p>Tgl/Waktu: ${receiptDate}</p><div class="separator"></div>
                <table class="receipt"><thead><tr class="text-sm"><th class="text-left" style="width: 50%">Item</th><th class="text-right" style="width: 20%">Qty</th><th class="text-right" style="width: 30%">Jumlah</th></tr></thead><tbody>${itemsHtml}</tbody></table>
                <div class="separator"></div><table class="receipt"><tr><td class="text-right" style="width: 70%">Total:</td><td class="text-right">Rp ${order.totalAmount.toLocaleString('id-ID')}</td></tr><tr><td class="text-right">Pembayaran:</td><td class="text-right">${paymentMethodName}</td></tr><tr><td class="text-right">Status:</td><td class="text-right">${order.status.toUpperCase()}</td></tr></table>
                <div class="separator"></div><div class="header" style="margin-top: 10px;"><p>Terima kasih atas kunjungan Anda!</p></div></body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.focus(); printWindow.print(); printWindow.close(); };
            showToast('info', 'Cetak', `Mencetak struk pesanan ${order.orderNumber}`);
        }

        function deleteOrder(orderId) {
            if (confirm('Apakah Anda yakin ingin menghapus pesanan ini?')) {
                dbData.orders = dbData.orders.filter(o => o.id !== orderId);
                dbData.queue = dbData.queue.filter(q => q.orderId !== orderId);
                loadOrdersTable();
                loadAdminQueue();
                loadAdminData();
                showToast('success', 'Berhasil', 'Pesanan telah dihapus');
            }
        }

        function loadAdminQueue() {
            const adminQueueList = document.getElementById('adminQueueList');
            adminQueueList.innerHTML = '';
            const statusTextMap = { 'waiting': 'Pesanan sedang dibuat', 'called': 'Silakan ambil pesanan anda', 'completed': 'Pesanan Selesai Diambil', 'cancelled': 'Dibatalkan', 'paid': 'Menunggu Tambah Antrian', 'pending': 'Menunggu Konfirmasi' };
            dbData.queue.sort((a, b) => a.id - b.id).forEach(item => {
                const statusColor = { 'waiting': 'bg-yellow-100 text-yellow-800', 'called': 'bg-blue-100 text-blue-800', 'completed': 'bg-green-100 text-green-800', 'cancelled': 'bg-red-100 text-red-800', 'paid': 'bg-gray-400 text-white', 'pending': 'bg-gray-100 text-gray-800' }[item.status] || 'bg-gray-100 text-gray-800';
                const statusText = statusTextMap[item.status] || item.status;
                adminQueueList.innerHTML += `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="text-2xl font-bold text-purple-600">${item.queueNumber}</h3><p class="font-semibold">${item.customerName}</p><p class="text-gray-600 text-sm">${item.customerPhone}</p></div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor}">${statusText}</span>
                        </div>
                        <div class="flex space-x-4">
                            ${(item.status === 'waiting' || item.status === 'called') ? `<button onclick="callCustomer(${item.orderId})" class="flex-1 bg-blue-600 text-white py-3 rounded hover:bg-blue-700 transition text-sm"><i class="fas fa-bullhorn mr-1"></i>Panggil</button>` : ''}
                            ${item.status === 'called' ? `<button onclick="completeQueue(${item.id})" class="flex-1 bg-green-600 text-white py-3 rounded hover:bg-green-700 transition text-sm"><i class="fas fa-check mr-1"></i>Selesaikan</button>` : ''}
                            ${item.status === 'completed' ? `<button onclick="printReceipt(${item.orderId})" class="flex-1 bg-blue-600 text-white py-3 rounded hover:bg-blue-700 transition text-sm"><i class="fas fa-print mr-1"></i>Cetak Struk</button>` : ''}
                            <button onclick="deleteQueue(${item.id})" class="bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        function completeQueue(queueId) {
            const queueItem = dbData.queue.find(q => q.id === queueId);
            if (queueItem) {
                queueItem.status = 'completed';
                const order = dbData.orders.find(o => o.id === queueItem.orderId);
                if (order) order.status = 'completed';
                loadAdminQueue();
                loadOrdersTable();
                loadAdminData();
                showToast('success', 'Berhasil', 'Antrian telah diselesaikan');
            }
        }

        function deleteQueue(queueId) {
            if (confirm('Apakah Anda yakin ingin menghapus antrian ini?')) {
                const queueItem = dbData.queue.find(q => q.id === queueId);
                if (queueItem) {
                    const order = dbData.orders.find(o => o.id === queueItem.orderId);
                    if (order && order.status === 'waiting') order.status = 'paid';
                }
                dbData.queue = dbData.queue.filter(q => q.id !== queueId);
                loadAdminQueue();
                loadOrdersTable();
                loadAdminData();
                showToast('success', 'Berhasil', 'Antrian telah dihapus');
            }
        }

        function loadAdminProducts() {
            const products = dbData.products;
            const adminProductsTable = document.getElementById('adminProductsTable');
            adminProductsTable.innerHTML = '';
            const startIndex = (productsCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = products.slice(startIndex, endIndex);
            paginatedProducts.forEach((product, index) => {
                adminProductsTable.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${startIndex + index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${product.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">Rp ${product.price.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 rounded-full text-xs font-semibold ${product.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${product.available ? 'Tersedia' : 'Habis'}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="flex space-x-2"><button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></div></td>
                    </tr>`;
            });
            renderProductsPagination(products.length);
        }

        function renderProductsPagination(totalItems) {
            const paginationContainer = document.getElementById('adminProductsPagination');
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;
            paginationContainer.innerHTML = `
                <button onclick="changeProductsPage(-1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${productsCurrentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                <span class="text-sm font-semibold my-2 sm:my-0">Halaman ${productsCurrentPage} dari ${totalPages}</span>
                <button onclick="changeProductsPage(1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${productsCurrentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
            `;
        }

        function changeProductsPage(direction) {
            productsCurrentPage += direction;
            loadAdminProducts();
        }

        function showProductModal() {
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModalTitle').textContent = 'Tambah Produk';
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = 'coffee';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStatus').value = 'true';
            editingProductId = null;
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        function editProduct(productId) {
            const product = dbData.products.find(p => p.id === productId);
            if (product) {
                document.getElementById('productModal').classList.remove('hidden');
                document.getElementById('productModalTitle').textContent = 'Edit Produk';
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStatus').value = product.available.toString();
                editingProductId = productId;
            }
        }

        function saveProduct(event) {
            event.preventDefault();
            const productData = {
                name: document.getElementById('productName').value, category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value, price: parseInt(document.getElementById('productPrice').value),
                available: document.getElementById('productStatus').value === 'true'
            };
            if (editingProductId) {
                const productIndex = dbData.products.findIndex(p => p.id === editingProductId);
                dbData.products[productIndex] = { ...dbData.products[productIndex], ...productData };
            } else {
                productData.id = Date.now();
                dbData.products.push(productData);
            }
            loadAdminProducts();
            loadProducts();
            closeProductModal();
            showToast('success', 'Berhasil', `Produk telah ${editingProductId ? 'diperbarui' : 'ditambahkan'}`);
        }

        function deleteProduct(productId) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                dbData.products = dbData.products.filter(p => p.id !== productId);
                productsCurrentPage = 1;
                loadAdminProducts();
                loadProducts();
                showToast('success', 'Berhasil', 'Produk telah dihapus');
            }
        }

        function loadUsersTable() {
            const users = dbData.users;
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '';
            const startIndex = (usersCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = users.slice(startIndex, endIndex);
            paginatedUsers.forEach(user => {
                usersTable.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${user.fullName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 rounded-full text-xs font-semibold ${user.role === 'superadmin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${user.role}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="flex space-x-2"><button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></div></td>
                    </tr>`;
            });
            renderUsersPagination(users.length);
        }

        function renderUsersPagination(totalItems) {
            const paginationContainer = document.getElementById('adminUsersPagination');
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;
            paginationContainer.innerHTML = `
                <button onclick="changeUsersPage(-1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${usersCurrentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                <span class="text-sm font-semibold my-2 sm:my-0">Halaman ${usersCurrentPage} dari ${totalPages}</span>
                <button onclick="changeUsersPage(1)" class="w-full sm:w-auto bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" ${usersCurrentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
            `;
        }

        function changeUsersPage(direction) {
            usersCurrentPage += direction;
            loadUsersTable();
        }

        function showUserModal() {
            document.getElementById('userModal').classList.remove('hidden');
            document.getElementById('userModalTitle').textContent = 'Tambah Admin';
            document.getElementById('userFullName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'admin';
            editingUserId = null;
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        function editUser(userId) {
            const user = dbData.users.find(u => u.id === userId);
            if (user) {
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userModalTitle').textContent = 'Edit Admin';
                document.getElementById('userFullName').value = user.fullName;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userRole').value = user.role;
                editingUserId = userId;
            }
        }

        function saveUser(event) {
            event.preventDefault();
            const userData = {
                username: document.getElementById('userUsername').value, password: document.getElementById('userPassword').value,
                fullName: document.getElementById('userFullName').value, role: document.getElementById('userRole').value
            };
            if (editingUserId) {
                const user = dbData.users.find(u => u.id === editingUserId);
                Object.assign(user, userData);
            } else {
                userData.id = Date.now();
                dbData.users.push(userData);
            }
            loadUsersTable();
            closeUserModal();
            showToast('success', 'Berhasil', `Admin telah ${editingUserId ? 'diperbarui' : 'ditambahkan'}`);
        }

        function deleteUser(userId) {
            if (confirm('Apakah Anda yakin ingin menghapus admin ini?')) {
                dbData.users = dbData.users.filter(u => u.id !== userId);
                usersCurrentPage = 1;
                loadUsersTable();
                showToast('success', 'Berhasil', 'Admin telah dihapus');
            }
        }

        function loadSettingsForm() {
            const settings = dbData.settings;
            document.getElementById('settingsMerchantName').value = settings.merchantName;
            document.getElementById('settingsJumbotronTitle').value = settings.jumbotronTitle;
            document.getElementById('settingsJumbotronSubtitle').value = settings.jumbotronSubtitle;
            document.getElementById('settingsAddress').value = settings.address;
            document.getElementById('settingsPhone').value = settings.phone;
            document.getElementById('settingsEmail').value = settings.email;
            document.getElementById('settingsHours').value = settings.hours;
            const paymentMethodsContainer = document.getElementById('settingsPaymentMethods');
            paymentMethodsContainer.innerHTML = '';
            settings.paymentMethods.forEach(method => {
                paymentMethodsContainer.innerHTML += `
                    <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" ${method.active ? 'checked' : ''} onchange="togglePaymentMethod('${method.id}', this.checked)"><i class="fas ${method.icon} text-purple-600"></i><span>${method.name}</span></label>`;
            });
        }

        function togglePaymentMethod(methodId, active) {
            const method = dbData.settings.paymentMethods.find(m => m.id === methodId);
            if (method) method.active = active;
        }

        function saveSettings(event) {
            event.preventDefault();
            dbData.settings = {
                ...dbData.settings,
                merchantName: document.getElementById('settingsMerchantName').value, jumbotronTitle: document.getElementById('settingsJumbotronTitle').value,
                jumbotronSubtitle: document.getElementById('settingsJumbotronSubtitle').value, address: document.getElementById('settingsAddress').value,
                phone: document.getElementById('settingsPhone').value, email: document.getElementById('settingsEmail').value,
                hours: document.getElementById('settingsHours').value
            };
            loadSettings();
            showToast('success', 'Berhasil', 'Pengaturan telah disimpan');
        }

        function loadReportsSection() {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('reportStartDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            generateReport();
        }

        function generateReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value);
            const endDate = new Date(document.getElementById('reportEndDate').value);
            endDate.setHours(23, 59, 59, 999);
            const filteredOrders = dbData.orders.filter(order => {
                const orderDate = new Date(order.createdAt);
                return orderDate >= startDate && orderDate <= endDate;
            });
            const totalOrders = filteredOrders.length;
            const totalRevenue = filteredOrders.filter(o => o.status === 'paid' || o.status === 'completed' || o.status === 'waiting').reduce((sum, o) => sum + o.totalAmount, 0);
            const paymentMethods = {};
            filteredOrders.forEach(order => {
                paymentMethods[order.paymentMethod] = (paymentMethods[order.paymentMethod] || 0) + 1;
            });
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div class="mb-6"><h3 class="text-xl font-semibold mb-4">Ringkasan Laporan</h3><div class="grid md:grid-cols-3 gap-4"><div class="bg-blue-50 p-4 rounded-lg"><p class="text-blue-600 font-semibold">Total Pesanan</p><p class="text-2xl font-bold">${totalOrders}</p></div><div class="bg-green-50 p-4 rounded-lg"><p class="text-green-600 font-semibold">Total Pendapatan</p><p class="text-2xl font-bold">Rp ${totalRevenue.toLocaleString()}</p></div><div class="bg-purple-50 p-4 rounded-lg"><p class="text-purple-600 font-semibold">Rata-rata</p><p class="text-2xl font-bold">Rp ${totalOrders > 0 ? Math.round(totalRevenue / totalOrders).toLocaleString() : 0}</p></div></div></div>
                <div class="mb-6"><h3 class="text-xl font-semibold mb-4">Metode Pembayaran</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4">${Object.entries(paymentMethods).map(([method, count]) => `<div class="bg-gray-50 p-4 rounded-lg text-center"><p class="font-semibold">${method}</p><p class="text-2xl font-bold">${count}</p></div>`).join('')}</div></div>
                <div><h3 class="text-xl font-semibold mb-4">Detail Pesanan</h3><div id="reportTableContainer" class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-50"><th class="border border-gray-300 px-4 py-2">No. Pesanan</th><th class="border border-gray-300 px-4 py-2">Tanggal</th><th class="border border-gray-300 px-4 py-2">Pelanggan</th><th class="border border-gray-300 px-4 py-2">Total</th><th class="border border-gray-300 px-4 py-2">Status</th></tr></thead>
                <tbody>${filteredOrders.map(order => `<tr><td class="border border-gray-300 px-4 py-2">${order.orderNumber}</td><td class="border border-gray-300 px-4 py-2">${new Date(order.createdAt).toLocaleDateString('id-ID')}</td><td class="border border-gray-300 px-4 py-2">${order.customerName}</td><td class="border border-gray-300 px-4 py-2">Rp ${order.totalAmount.toLocaleString()}</td><td class="border border-gray-300 px-4 py-2">${order.status}</td></tr>`).join('')}</tbody></table></div></div>`;
        }

        function printReport() {
            const merchantName = dbData.settings.merchantName;
            const printWindow = window.open('', '_blank');
            const tableContainer = document.getElementById('reportTableContainer');
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const printHTML = `<!DOCTYPE html><html><head><title>Laporan Transaksi ${merchantName}</title><style> body { font-family: 'Poppins', Arial, sans-serif; margin: 20px; color: #000; background: white; } h1 { text-align: center; margin-bottom: 10px; color: #000; font-size: 18px; font-weight: bold; } h2 { text-align: center; margin-bottom: 20px; color: #000; font-size: 14px; } h3 { text-align: center; margin-bottom: 15px; color: #000; font-size: 14px; font-weight: bold; } table { width: 100%; border-collapse: collapse; margin-top: 10px; } th, td { border: 1px solid #000; padding: 6px; text-align: left; font-size: 12px; } th { background-color: #f5f5f5; font-weight: bold; } @media print { body { margin: 10px; } h1 { font-size: 16px; } h2 { font-size: 12px; } h3 { font-size: 12px; } th, td { padding: 4px; font-size: 10px; } } </style></head>
                <body><h1>LAPORAN TRANSAKSI ${merchantName.toUpperCase()}</h1><h2>Periode: ${formatDate(startDate)} - ${formatDate(endDate)}</h2><h3>DETAIL PESANAN</h3>${tableContainer ? tableContainer.innerHTML : '<p>Tidak ada data untuk ditampilkan</p>'}</body></html>`;
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.onload = function() { printWindow.focus(); printWindow.print(); printWindow.close(); };
        }

        function downloadDatabase() {
            const notepadContent = JSON.stringify(dbData, null, 2);
            const blob = new Blob([notepadContent], { type: 'application/json;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kopiku_database_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('success', 'Berhasil', 'Database telah diunduh');
        }
        
        function handleImportDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (confirm('PERINGATAN: Mengimpor database akan menimpa data aplikasi yang ada. Lanjutkan?')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.settings && importedData.products && importedData.orders) {
                            dbData = importedData; // Replace in-memory data
                            showToast('success', 'Import Berhasil', 'Database berhasil diimpor. Memuat ulang data...');
                            initializeApp(); // Re-initialize the app with the new data
                        } else {
                            showToast('error', 'Import Gagal', 'Struktur file database tidak valid.');
                        }
                    } catch (error) {
                        showToast('error', 'Import Gagal', 'File tidak dalam format JSON yang benar.');
                        console.error('Import Database Error:', error);
                    }
                };
                reader.onerror = function() { showToast('error', 'Import Gagal', 'Gagal membaca file.'); };
                reader.readAsText(file);
            }
        }

        function sendContactMessage(event) {
            event.preventDefault();
            const message = {
                id: Date.now(), name: event.target[0].value, email: event.target[1].value,
                message: event.target[2].value, createdAt: new Date().toISOString()
            };
            dbData.messages.push(message);
            event.target.reset();
            showToast('success', 'Berhasil', 'Pesan Anda telah terkirim');
        }

        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const icons = {
                success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                error: '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>',
                info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };
            toastIcon.innerHTML = icons[type] || icons.info;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            filterProducts('all');
        });
    </script>
</body>
</html>
